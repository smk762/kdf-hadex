#!/command/with-contenv bash
# shellcheck shell=bash
set -euo pipefail

echo "[panel-server] Starting KDF Panel Server"

# KDF Ingress server is always enabled
echo "[panel-server] KDF Ingress server is enabled"

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "[panel-server] ERROR: Python3 not found"
    exit 1
fi

# Check if the panel server script exists
if [[ ! -f /usr/local/bin/panel-server.py ]]; then
    echo "[panel-server] ERROR: Panel server script not found"
    exit 1
fi

# Make the script executable
chmod +x /usr/local/bin/panel-server.py

# Start the panel server
if [[ -x "/opt/kdf-venv/bin/python3" ]]; then
    echo "[panel-server] Using venv python: /opt/kdf-venv/bin/python3"
    exec /opt/kdf-venv/bin/python3 /usr/local/bin/panel-server.py
else
    echo "[panel-server] venv python not found; falling back to system python3"
    exec python3 /usr/local/bin/panel-server.py
fi
