#!/command/with-contenv bash
# shellcheck shell=bash
set -euo pipefail

echo "[panel-server] Starting KDF Panel Server"

# KDF Ingress server is always enabled
echo "[panel-server] KDF Ingress server is enabled"

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "[panel-server] ERROR: Python3 not found"
    exit 1
fi

# Check if the panel server script exists
if [[ ! -f /usr/local/bin/panel-server.py ]]; then
    echo "[panel-server] ERROR: Panel server script not found"
    exit 1
fi

# Make the script executable
chmod +x /usr/local/bin/panel-server.py

# Start the panel server
echo "[panel-server] Starting KDF panel server..."
# Prefer virtualenv python if available
if [[ -x "/opt/kdf-venv/bin/python3" ]]; then
    echo "[panel-server] Using venv python: /opt/kdf-venv/bin/python3"
    echo "[panel-server] Python version: $(/opt/kdf-venv/bin/python3 --version)"
    echo "[panel-server] Panel server script exists: $(ls -la /usr/local/bin/panel-server.py)"
    echo "[panel-server] Dashboard file exists: $(ls -la /root/www/kdf-panel.html)"
    echo "[panel-server] Starting full panel server (venv)..."
    # Launch via the venv python so the script's __main__ will start uvicorn and avoid module import issues
    exec /opt/kdf-venv/bin/python3 /usr/local/bin/panel-server.py
else
    echo "[panel-server] venv python not found; falling back to system python3"
    echo "[panel-server] Python version: $(python3 --version)"
    echo "[panel-server] Panel server script exists: $(ls -la /usr/local/bin/panel-server.py)"
    echo "[panel-server] Dashboard file exists: $(ls -la /root/www/kdf-panel.html)"
    echo "[panel-server] Starting full panel server..."
    # Run the panel-server via system python so the script's __main__ will launch uvicorn
    exec python3 /usr/local/bin/panel-server.py
fi
