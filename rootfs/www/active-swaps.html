<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KDF Active Swaps</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#111;color:#fff;padding:20px}
        .container{max-width:1100px;margin:0 auto}
        .card{background:#161616;border:1px solid #2a2a2a;border-radius:8px;padding:16px;margin-bottom:16px}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{padding:8px;border-bottom:1px solid #222;text-align:left}
        th{color:#9aa;font-weight:600}
        .hint{font-size:0.9rem;color:#888}
        .loading{color:#888}
    </style>
</head>
<body>
<div class="container">
    <h1>KDF Active Swaps</h1>
    <p class="hint">Live active swaps from KDF. Refreshes automatically.</p>

    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="hint">Auto-refresh every 30s</div>
            <div><button id="refresh">Refresh</button></div>
        </div>
    </div>

    <div id="result-card" class="card">
        <div id="message" class="hint">No results yet.</div>
        <div style="overflow:auto;margin-top:8px">
            <table id="swaps-table">
                <thead>
                    <tr>
                        <th>UUID</th>
                        <th>My Coin</th>
                        <th>Other Coin</th>
                        <th>My Amount</th>
                        <th>Other Amount</th>
                        <th>Started At (UTC)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="swaps-body"><tr><td colspan="7" class="loading">No data</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const refreshBtn = document.getElementById('refresh');
    const swapsBody = document.getElementById('swaps-body');
    const msg = document.getElementById('message');

    function showHint(t){ msg.textContent = t; msg.className = 'hint'; }
    function showError(t){ msg.textContent = t; msg.className = 'error'; }

    function formatTs(ts){ if(!ts) return '--'; try{ return new Date(Number(ts)*1000).toISOString().replace('T',' ').split('.')[0] + ' UTC'; }catch(e){return ts} }

    function renderSwapsList(rows){
        swapsBody.innerHTML = '';
        if(!rows || rows.length===0){ swapsBody.innerHTML = '<tr><td colspan="7" class="hint">No active swaps</td></tr>'; return; }
        for(const r of rows){
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.uuid}</td>
                <td>${r.my_coin}</td>
                <td>${r.other_coin}</td>
                <td>${r.my_amount}</td>
                <td>${r.other_amount}</td>
                <td>${formatTs(r.started_at)}</td>
                <td>in progress</td>
            `;
            swapsBody.appendChild(tr);
        }
    }

    async function fetchActiveSwaps(){
        showHint('Fetching active_swaps...');
        swapsBody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';
        try{
            const payload = { method: 'active_swaps', mmrpc: '2.0', params: { include_status: true } };
            const res = await fetch('./api/kdf_request',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if(!res.ok){ const t = await res.text(); showError(`HTTP ${res.status}: ${t}`); return; }
            const j = await res.json();
            const data = j && (j.result || j);
            if(!data){ showError('Empty response'); return; }
            if(data.error){ showError(typeof data.error === 'string' ? data.error : JSON.stringify(data.error)); return; }

            // result.statuses is expected to be a map of uuid -> { swap_data: { ... } }
            const statuses = data.statuses || {};
            const rows = [];
            for(const [uuid, st] of Object.entries(statuses)){
                const sd = (st && st.swap_data) ? st.swap_data : st;
                const my_info = sd && sd.my_info ? sd.my_info : {};
                rows.push({ uuid, my_coin: my_info.my_coin || '', other_coin: my_info.other_coin || '', my_amount: my_info.my_amount || '', other_amount: my_info.other_amount || '', started_at: my_info.started_at || sd.started_at || '' });
            }
            renderSwapsList(rows);
            showHint('Results loaded');
        }catch(e){ console.error(e); showError('Request failed: '+(e && e.message?e.message:String(e))); }
    }

    refreshBtn.addEventListener('click', ()=>fetchActiveSwaps());

    // auto-refresh
    fetchActiveSwaps();
    setInterval(fetchActiveSwaps, 30000);
</script>

</body>
</html>


