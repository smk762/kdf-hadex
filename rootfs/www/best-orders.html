<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KDF Best Orders</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#111;color:#fff;padding:20px}
        .container{max-width:1100px;margin:0 auto}
        .card{background:#161616;border:1px solid #2a2a2a;border-radius:8px;padding:16px;margin-bottom:16px}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        label{font-size:0.9rem;color:#aaa}
        input,select{padding:8px;border-radius:6px;background:#0f0f0f;border:1px solid #2a2a2a;color:#fff}
        button{background:#00d4aa;color:#000;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{padding:8px;border-bottom:1px solid #222;text-align:right}
        th{color:#9aa;font-weight:600;text-align:right}
        td.left{text-align:left}
        .error{color:#ff6666;padding:12px;background:#2a1a1a;border-radius:6px}
        .hint{font-size:0.9rem;color:#888}
    </style>
</head>
<body>
<div class="container">
    <h1>KDF Best Orders</h1>
    <p class="hint">Send a best_orders request via the panel server. Results are displayed below.</p>

    <div class="card">
        <div class="row" style="margin-bottom:8px">
            <div style="flex:1;min-width:180px">
                <label for="coin-select" id="coin-label">Ticker (coin)</label><br>
                <select id="coin-select"></select>
            </div>

            <div style="width:140px">
                <label for="action">Action</label><br>
                <select id="action">
                    <option value="sell">sell</option>
                    <option value="buy">buy</option>
                </select>
            </div>

            <div style="width:160px">
                <label for="exclude_mine">Exclude mine</label><br>
                <select id="exclude_mine">
                    <option value="true">true</option>
                    <option value="false">false</option>
                </select>
            </div>

            <div style="width:140px">
                <label for="req_type">Request by</label><br>
                <select id="req_type">
                    <option value="number">number</option>
                    <option value="volume">volume</option>
                </select>
            </div>

            <div style="width:120px">
                <label for="req_value">Value</label><br>
                <input id="req_value" type="number" step="any" value="1" />
            </div>

            <div style="flex:0 0 auto">
                <label>&nbsp;</label><br>
                <button id="send">Send</button>
            </div>
        </div>

    </div>

    <div id="result-card" class="card">
        <div id="message" class="hint">No results yet.</div>
        <div style="overflow:auto;margin-top:8px">
            <table id="orders-table">
                <thead>
                    <tr>
                        <th class="left">Ticker</th>
                        <th>Price</th>
                        <th>Price (fiat)</th>
                        <th>Min Rel Vol</th>
                        <th>Max Rel Vol</th>
                        <th>Min Base Vol</th>
                        <th>Max Base Vol</th>
                    </tr>
                </thead>
                <tbody id="orders-body"><tr><td colspan="7" class="hint">No data</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const sendBtn = document.getElementById('send');
    const ordersBody = document.getElementById('orders-body');
    const msg = document.getElementById('message');
    const selectedFiatEl = document.getElementById('selected-fiat');

    let selectedFiat = null;

    async function loadOptions() {
        try {
            const r = await fetch('./api/options');
            if (!r.ok) return;
            const j = await r.json();
            const opts = (j && j.options) ? j.options : {};
            selectedFiat = opts.selected_fiat_currency || null;
            selectedFiatEl.textContent = selectedFiat || 'N/A';
        } catch (e) {
            console.error('failed to load options', e);
        }
    }

    function clearTable() {
        ordersBody.innerHTML = '<tr><td colspan="7" class="hint">No data</td></tr>';
    }

    function showError(text) {
        msg.textContent = text;
        msg.className = 'error';
    }

    function showHint(text) {
        msg.textContent = text;
        msg.className = 'hint';
    }

    document.getElementById('action').addEventListener('change', (e)=>{
        const action = e.target.value;
        const lbl = document.getElementById('coin-label');
        lbl.textContent = (action === 'buy') ? 'Buy coin' : 'Sell coin';
    });

    sendBtn.addEventListener('click', async () => {
        const coin = (document.getElementById('coin-select').value || '').trim().toUpperCase();
        const action = document.getElementById('action').value;
        const exclude_mine = document.getElementById('exclude_mine').value === 'true';
        const req_type = document.getElementById('req_type').value;
        const req_value = parseFloat(document.getElementById('req_value').value) || 0;

        if (!coin) { showError('Ticker required'); return; }

        const payload = {
            method: 'best_orders',
            mmrpc: '2.0',
            params: {
                coin: coin,
                exclude_mine: exclude_mine,
                action: action,
                request_by: {
                    type: req_type,
                    value: req_value
                }
            }
        };

        showHint('Sending request...');
        clearTable();

        try {
            const res = await fetch('./api/kdf_request', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            if (!res.ok) {
                const t = await res.text();
                showError(`HTTP ${res.status}: ${t}`);
                return;
            }
            const j = await res.json();
            const data = j && (j.result || j) ;
            if (!data) { showError('Empty response'); return; }
            if (data.error) { showError(typeof data.error === 'string' ? data.error : JSON.stringify(data.error)); return; }

            // Expect data.orders -> dict of ticker: [orders]
            const ordersMap = data.orders || data;
            renderOrders(ordersMap);
            showHint('Results loaded');
        } catch (e) {
            console.error(e);
            showError('Request failed: ' + (e && e.message ? e.message : String(e)));
        }
    });

    function tryDecimal(obj, path) {
        try {
            const parts = path.split('.');
            let cur = obj;
            for (const p of parts) {
                if (!cur) return null;
                cur = cur[p];
            }
            return cur && cur.decimal ? cur.decimal : (typeof cur === 'string' ? cur : null);
        } catch (e) { return null; }
    }

    function round6(v) {
        const n = Number(v);
        if (!isFinite(n)) return v;
        return n.toFixed(6);
    }

    function renderOrders(map) {
        ordersBody.innerHTML = '';
        const rows = [];
        for (const [ticker, arr] of Object.entries(map || {})) {
            if (!Array.isArray(arr)) continue;
            for (const o of arr) {
                const price = tryDecimal(o, 'price') || (o.price && (o.price.decimal||o.price));
                const min_rel = tryDecimal(o, 'rel_min_volume') || tryDecimal(o, 'rel_min_volume') || tryDecimal(o, 'rel_min_volume');
                const max_rel = tryDecimal(o, 'rel_max_volume') || tryDecimal(o, 'rel_max_volume') || tryDecimal(o, 'rel_max_volume');
                const min_base = tryDecimal(o, 'base_min_volume') || tryDecimal(o, 'base_min_volume');
                const max_base = tryDecimal(o, 'base_max_volume') || tryDecimal(o, 'base_max_volume');

                const priceNum = price ? Number(price) : NaN;
                let priceFiat = 'N/A';
                // Only show fiat if selected fiat matches rel (best-effort)
                const relTicker = o && o.rel ? o.rel : null;
                if (selectedFiat && relTicker && relTicker.toUpperCase() === selectedFiat.toUpperCase()) {
                    priceFiat = isNaN(priceNum) ? 'N/A' : Number(priceNum).toString();
                }

                rows.push({ ticker, price, priceFiat, min_rel, max_rel, min_base, max_base });
            }
        }

        if (rows.length === 0) {
            ordersBody.innerHTML = '<tr><td colspan="7" class="hint">No orders returned</td></tr>';
            return;
        }

        for (const r of rows) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="left">${r.ticker}</td>
                <td>${r.price ? round6(r.price) : '--'}</td>
                <td>${r.priceFiat && r.priceFiat!=='N/A' ? round6(r.priceFiat) : 'N/A'}</td>
                <td>${r.min_rel ? round6(r.min_rel) : '--'}</td>
                <td>${r.max_rel ? round6(r.max_rel) : '--'}</td>
                <td>${r.min_base ? round6(r.min_base) : '--'}</td>
                <td>${r.max_base ? round6(r.max_base) : '--'}</td>
            `;
            ordersBody.appendChild(tr);
        }
    }

    // populate datalist from panel coins_config / supported_coins
    async function populateTickers(){
        try{
            const r = await fetch('./api/coins_config');
            if(!r.ok) return;
            const j = await r.json();
            const coins = j.supported_coins && Array.isArray(j.supported_coins) && j.supported_coins.length ? j.supported_coins : Object.keys(j.coins_config||{});
            const sel = document.getElementById('coin-select');
            sel.innerHTML = '';
            coins.forEach(t=>{
                const info = (j.coins_config||{})[t]||{};
                const label = info.name || t;
                const o = document.createElement('option'); o.value = t; o.text = `${t} — ${label}`; sel.appendChild(o);
            });
        }catch(e){console.error('failed to populate tickers',e)}
    }

    // init
    (async function(){ await loadOptions(); await populateTickers(); })();
</script>

</body>
</html>


