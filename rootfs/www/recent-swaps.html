<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>KDF Recent Swaps</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#111;color:#fff;padding:20px}
        .container{max-width:1100px;margin:0 auto}
        .card{background:#161616;border:1px solid #2a2a2a;border-radius:8px;padding:16px;margin-bottom:16px}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        label{font-size:0.9rem;color:#aaa}
        input,select{padding:8px;border-radius:6px;background:#0f0f0f;border:1px solid #2a2a2a;color:#fff}
        button{background:#00d4aa;color:#000;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{padding:8px;border-bottom:1px solid #222;text-align:left}
        th{color:#9aa;font-weight:600}
        .error{color:#ff6666;padding:12px;background:#2a1a1a;border-radius:6px}
        .hint{font-size:0.9rem;color:#888}
        .status-success{color:#66ff99}
        .status-failed{color:#ff6b6b}
        .status-progress{color:#ffd166}
    </style>
</head>
<body>
<div class="container">
    <h1>KDF Recent Swaps</h1>
    <p class="hint">Query recent swaps via the panel server. Leave tickers as "All" to omit the filter.</p>

    <div class="card">
        <div class="row" style="margin-bottom:8px">
            <div style="width:220px">
                <label for="my_coin">My coin</label><br>
                <select id="my_coin"><option value="">All</option></select>
            </div>

            <div style="width:220px">
                <label for="other_coin">Other coin</label><br>
                <select id="other_coin"><option value="">All</option></select>
            </div>

            <div style="width:240px">
                <label for="from_ts">From (UTC)</label><br>
                <input id="from_ts" type="datetime-local" />
            </div>

            <div style="width:240px">
                <label for="to_ts">To (UTC)</label><br>
                <input id="to_ts" type="datetime-local" />
            </div>

            <div style="width:120px">
                <label for="limit">Limit</label><br>
                <input id="limit" type="number" value="100" min="1" />
            </div>

            <div style="width:120px">
                <label for="page_number">Page</label><br>
                <input id="page_number" type="number" value="1" min="1" />
            </div>

            <div style="flex:0 0 auto">
                <label>&nbsp;</label><br>
                <button id="send">Send</button>
            </div>
        </div>
    </div>

    <div id="result-card" class="card">
        <div id="message" class="hint">No results yet.</div>
        <div style="overflow:auto;margin-top:8px">
            <table id="swaps-table">
                <thead>
                    <tr>
                        <th>UUID</th>
                        <th>My Coin</th>
                        <th>Other Coin</th>
                        <th>My Amount</th>
                        <th>Other Amount</th>
                        <th>Started At (UTC)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="swaps-body"><tr><td colspan="7" class="hint">No data</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const sendBtn = document.getElementById('send');
    const swapsBody = document.getElementById('swaps-body');
    const msg = document.getElementById('message');

    async function populateTickers(){
        try{
            const r = await fetch('./api/coins_config');
            if(!r.ok) return;
            const j = await r.json();
            const coins = j.supported_coins && Array.isArray(j.supported_coins) && j.supported_coins.length ? j.supported_coins : Object.keys(j.coins_config||{});
            const my = document.getElementById('my_coin');
            const other = document.getElementById('other_coin');
            coins.forEach(t=>{
                const o1 = document.createElement('option'); o1.value = t; o1.text = t; my.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = t; o2.text = t; other.appendChild(o2);
            });
        }catch(e){console.error('failed to populate tickers',e)}
    }

    function showError(text){ msg.textContent = text; msg.className = 'error'; }
    function showHint(text){ msg.textContent = text; msg.className = 'hint'; }

    function toUnixSeconds(dtLocalValue){
        if(!dtLocalValue) return null;
        const d = new Date(dtLocalValue);
        if (isNaN(d.getTime())) return null;
        return Math.floor(d.getTime()/1000);
    }

    sendBtn.addEventListener('click', async ()=>{
        const my_coin = document.getElementById('my_coin').value || null;
        const other_coin = document.getElementById('other_coin').value || null;
        const from_ts = toUnixSeconds(document.getElementById('from_ts').value);
        const to_ts = toUnixSeconds(document.getElementById('to_ts').value);
        const limit = parseInt(document.getElementById('limit').value) || 100;
        const page_number = parseInt(document.getElementById('page_number').value) || 1;

        const filter = {};
        if (my_coin) filter.my_coin = my_coin;
        if (other_coin) filter.other_coin = other_coin;
        if (from_ts !== null) filter.from_timestamp = from_ts;
        if (to_ts !== null) filter.to_timestamp = to_ts;
        if (limit) filter.limit = limit;
        if (page_number) filter.page_number = page_number;

        const payload = { method: 'my_recent_swaps', mmrpc: '2.0', params: { filter } };

        showHint('Sending request...');
        swapsBody.innerHTML = '<tr><td colspan="7" class="hint">Loading...</td></tr>';

        try{
            const res = await fetch('./api/kdf_request',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if(!res.ok){ const t = await res.text(); showError(`HTTP ${res.status}: ${t}`); return; }
            const j = await res.json();
            const data = j && (j.result || j);
            if(!data){ showError('Empty response'); return; }
            if(data.error){ showError(typeof data.error === 'string' ? data.error : JSON.stringify(data.error)); return; }

            const swaps = data.swaps || [];
            renderSwaps(swaps);
            showHint('Results loaded');
        }catch(e){ console.error(e); showError('Request failed: '+(e && e.message?e.message:String(e))); }
    });

    function formatTs(ts){ if(!ts) return '--'; try{ return new Date(Number(ts)*1000).toISOString().replace('T',' ').split('.')[0] + ' UTC'; }catch(e){return ts} }

    function determineStatus(events){
        if(!events || !Array.isArray(events)) return 'in progress';
        const types = events.map(it=>{ try{ return (it.event && it.event.type) || it.type || ''; }catch(e){return ''} });
        const hasMakerSpent = types.includes('MakerPaymentSpent') || types.includes('MakerPaymentSpentByWatcher');
        const hasTakerSpent = types.includes('TakerPaymentSpent');
        const anyFailedOrRefund = types.some(t => t && (t.indexOf('Failed') !== -1 || t.indexOf('Refund') !== -1));
        if(anyFailedOrRefund) return 'failed';
        if(hasMakerSpent && hasTakerSpent) return 'successful';
        return 'in progress';
    }

    function renderSwaps(swaps){
        swapsBody.innerHTML = '';
        if(!swaps || swaps.length===0){ swapsBody.innerHTML = '<tr><td colspan="7" class="hint">No swaps</td></tr>'; return; }
        for(const s of swaps){
            const uuid = s.uuid || s.my_order_uuid || '';
            const my_info = s.my_info || {};
            const my_coin = my_info.my_coin || '';
            const other_coin = my_info.other_coin || '';
            const my_amount = my_info.my_amount || '';
            const other_amount = my_info.other_amount || '';
            const started_at = my_info.started_at || s.started_at || '';
            const status = determineStatus(s.events || []);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${uuid}</td>
                <td>${my_coin}</td>
                <td>${other_coin}</td>
                <td>${my_amount}</td>
                <td>${other_amount}</td>
                <td>${formatTs(started_at)}</td>
                <td class="status-${status==='successful'? 'success' : status==='failed' ? 'failed' : 'progress'}">${status}</td>
            `;
            swapsBody.appendChild(tr);
        }
    }

    // init
    (async function(){ await populateTickers(); })();
</script>

</body>
</html>


